<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Today vs Master Lease + Option Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background-color: #f5f7fa;
        color: #2d3748;
        line-height: 1.5;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #1a202c;
        font-weight: 700;
    }

    .how-to-use {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .how-to-toggle {
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: #4299e1;
        user-select: none;
    }

    .how-to-content {
        margin-top: 15px;
        display: none;
    }

    .how-to-content.show {
        display: block;
    }

    .assumptions-panel {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .panel-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: #1a202c;
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 8px;
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .input-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .input-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        color: #4a5568;
    }

    .tooltip {
        cursor: help;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #4299e1;
        color: white;
        border-radius: 50%;
        font-size: 11px;
        font-weight: bold;
        position: relative;
    }

    .tooltip:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        background: #1a202c;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 100;
        max-width: 200px;
        white-space: normal;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4299e1;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4299e1;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input[type="number"] {
        padding: 8px 12px;
        border: 2px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        width: 120px;
    }

    input[type="number"]:focus {
        outline: none;
        border-color: #4299e1;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 26px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #4299e1;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .value-display {
        font-weight: 600;
        color: #2d3748;
        min-width: 80px;
        text-align: right;
    }

    .scenarios {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .scenario-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    }

    .scenario-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 20px;
        color: #1a202c;
        text-align: center;
    }

    .big-result {
        text-align: center;
        margin: 20px 0;
        padding: 20px;
        background: #f7fafc;
        border-radius: 8px;
        border-left: 4px solid #4299e1;
    }

    .big-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 5px;
    }

    .big-number.negative {
        color: #e53e3e;
    }

    .big-label {
        font-size: 14px;
        color: #718096;
        font-weight: 500;
    }

    .result-details {
        margin-top: 20px;
    }

    .result-table {
        background: #f7fafc;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

    .result-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e2e8f0;
    }

    .result-row:last-child {
        border-bottom: none;
        font-weight: 600;
        padding-top: 12px;
        margin-top: 8px;
        border-top: 2px solid #4299e1;
    }

    .result-row.negative .result-value {
        color: #e53e3e;
    }

    .result-label {
        color: #4a5568;
    }

    .result-value {
        font-weight: 600;
        color: #1a202c;
    }

    .collapsible-section {
        margin: 15px 0;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
    }

    .collapsible-header {
        background: #f7fafc;
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
    }

    .collapsible-content {
        padding: 15px;
        display: none;
    }

    .collapsible-content.show {
        display: block;
    }

    .reset-button {
        background: #e53e3e;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
        margin-top: 20px;
    }

    .reset-button:hover {
        background: #c53030;
    }

    .winner-highlight {
        background: linear-gradient(135deg, #f0fdf4, #dcfce7) !important;
        border-left: 4px solid #22c55e !important;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15) !important;
    }

    .assumption-note {
        background: #fffaf0;
        border-left: 4px solid #f6ad55;
        padding: 12px;
        margin-top: 15px;
        font-size: 14px;
        color: #744210;
    }

    @media (max-width: 768px) {
        .scenarios {
            grid-template-columns: 1fr;
        }
        
        .input-grid {
            grid-template-columns: 1fr;
        }
        
        .big-number {
            font-size: 2rem;
        }
    }
</style>

</head>
<body>
    <div class="container">
        <h1>Sell Today vs Master Lease + Option Calculator</h1>

    <div class="how-to-use">
        <div class="how-to-toggle" onclick="toggleHowTo()">
            <span>üìñ How to Use This Calculator</span>
            <span id="how-to-arrow">‚ñº</span>
        </div>
        <div class="how-to-content" id="how-to-content">
            <p><strong>Purpose:</strong> Compare selling your property today as-is versus a Master Lease + Option (MLO) arrangement.</p>
            <ul style="margin: 15px 0 15px 20px;">
                <li><strong>Sell Today:</strong> Immediate sale but with commission, taxes, fees, and holding costs</li>
                <li><strong>MLO:</strong> Lease property with option to buy, receiving monthly premiums above mortgage, option consideration (cash + improvements), principal paydown plus eventual sale proceeds</li>
            </ul>
            <p><strong>Instructions:</strong> Adjust the sliders and inputs to model how diffent scendarios affect net proceeds. Results update automatically. Use the PV toggle to see present value calculations at your chosen discount rate.</p>
        </div>
    </div>

    <div class="assumptions-panel">
        <h3 class="panel-title">Global Assumptions</h3>
        <div class="input-grid">
            <div class="input-group">
                <div class="input-label">
                    <span>Conveyance Tax</span>
                    <span class="tooltip" data-tooltip="Mandatory, two-part tax paid by the seller based on sale/exercise price. State Tax: 0.75%; Municipal Tax: 0.25%">i</span>
                </div>
                <div class="input-wrapper">
                    <input type="range" id="conveyanceTax" min="1.0" max="1.0" step="0.1" value="1.0">
                    <span class="value-display" id="conveyanceTaxValue">1.0%</span>
                </div>
            </div>
            
            <div class="input-group">
                <div class="input-label">
                    <span>Attorney Fee</span>
                    <span class="tooltip" data-tooltip="Legal fees for closing">i</span>
                </div>
                <div class="input-wrapper">
                    <input type="number" id="attorneyFee" value="1500" min="0" step="100">
                </div>
            </div>
            
            <div class="input-group">
                <div class="input-label">
                    <span>Discount Rate (PV)</span>
                    <span class="tooltip" data-tooltip="Annual rate for present value calculations. Choose a rate that reflects what you could earn on the lump sum of cash if you sold today.">i</span>
                </div>
                <div class="input-wrapper">
                    <input type="range" id="discountRate" min="0" max="10" step="0.1" value="3.0">
                    <span class="value-display" id="discountRateValue">3.0%</span>
                </div>
            </div>
            
            <div class="input-group">
                <div class="input-label">
                    <span>Show Present Value</span>
                    <span class="tooltip" data-tooltip="Display PV calculations alongside nominal values">i</span>
                </div>
                <div class="input-wrapper">
                    <label class="toggle-switch">
                        <input type="checkbox" id="showPV">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <div class="assumptions-panel">
        <h3 class="panel-title">Mortgage Information</h3>
        <div class="input-grid">
                <div class="input-group">
                    <div class="input-label">
                        <span>Current Balance</span>
                        <span class="tooltip" data-tooltip="Remaining mortgage balance today">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="currentBalance" value="30772" min="0" step="1000">
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>APR</span>
                        <span class="tooltip" data-tooltip="Annual percentage rate">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="mortgageAPR" min="0" max="10" step="0.01" value="2.68">
                        <span class="value-display" id="mortgageAPRValue">2.68%</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Monthly P&I Payment</span>
                        <span class="tooltip" data-tooltip="Principal and interest payment">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="monthlyPayment" value="1097.02" min="0" step="10">
                    </div>
                </div>
        </div>
    </div>

    <div class="scenarios">
        <div class="scenario-card">
            <h3 class="scenario-title">üè† Sell Today (As-Is)</h3>
            
            <div class="input-grid">
                <div class="input-group">
                    <div class="input-label">
                        <span>Sale Price</span>
                        <span class="tooltip" data-tooltip="Expected sale price">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="salePrice" min="150000" max="450000" step="5000" value="295000">
                        <span class="value-display" id="salePriceValue">$295,000</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Commission</span>
                        <span class="tooltip" data-tooltip="Real estate commission percentage">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="commission" min="0" max="6" step="0.1" value="5.0">
                        <span class="value-display" id="commissionValue">5.0%</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>FSBO (No Commission)</span>
                        <span class="tooltip" data-tooltip="For Sale By Owner - zero commission">i</span>
                    </div>
                    <div class="input-wrapper">
                        <label class="toggle-switch">
                            <input type="checkbox" id="fsbo">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Sale Timing (Months)</span>
                        <span class="tooltip" data-tooltip="Months from today until sale">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="saleTiming" min="0" max="60" step="1" value="0">
                        <span class="value-display" id="saleTimingValue">0 months</span>
                    </div>
                </div>
            </div>
            
            <div class="assumptions-panel">
                <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #1a202c;">Monthly Holding Costs</h4>
                <div class="input-grid">
                    <div class="input-group">
                        <div class="input-label">
                            <span>Property Taxes</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="holdingTaxes" value="0" min="0" step="50">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Insurance</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="holdingInsurance" value="0" min="0" step="25">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Principal</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="holdingPrincipal" value="0" min="0" step="25">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Interest</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="holdingInterest" value="0" min="0" step="25">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-label">
                            <span>Utilities</span>
                        </div>
                        <div class="input-wrapper">
                            <input type="number" id="holdingUtilities" value="0" min="0" step="25">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="big-result">
                <div class="big-number" id="sellTodayNet">$244,800</div>
                <div class="big-label">Net Proceeds to Seller</div>
                <div class="big-number" id="sellTodayPV" style="font-size: 1.5rem; margin-top: 10px; display: none;">
                    PV: $244,800
                </div>
            </div>
            
            <div class="result-details">
                <div class="result-table" id="sellTodayBreakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="scenario-card">
            <h3 class="scenario-title">üìã Master Lease + Option</h3>
            
            <div class="input-grid">
                <div class="input-group">
                    <div class="input-label">
                        <span>Exercise Timing (Months)</span>
                        <span class="tooltip" data-tooltip="When buyer exercises option">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="exerciseTiming" min="6" max="60" step="1" value="36">
                        <span class="value-display" id="exerciseTimingValue">36 months</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Strike Price</span>
                        <span class="tooltip" data-tooltip="Option exercise price">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="strikePrice" min="270000" max="300000" step="1000" value="285000">
                        <span class="value-display" id="strikePriceValue">$282,500</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Monthly Lease Payment</span>
                        <span class="tooltip" data-tooltip="Monthly rent paid to seller">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="leasePayment" value="1150" min="0" step="50">
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Option Fee</span>
                        <span class="tooltip" data-tooltip="Upfront option consideration">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="number" id="optionFee" value="2000" min="0" step="500">
                    </div>
                </div>
                
                <div class="input-group">
                    <div class="input-label">
                        <span>Improvement Credits</span>
                        <span class="tooltip" data-tooltip="Credits for improvements (reduces closing proceeds)">i</span>
                    </div>
                    <div class="input-wrapper">
                        <input type="range" id="improvementCredits" min="10000" max="20000" step="1000" value="10000">
                        <span class="value-display" id="improvementCreditsValue">$10,000</span>
                    </div>
                </div>
            </div>
            
            <div class="big-result">
                <div class="big-number" id="mloTotal">$276,665</div>
                <div class="big-label">Net Proceeds to Seller</div>
                <div class="big-number" id="mloPV" style="font-size: 1.5rem; margin-top: 10px; display: none;">
                    PV: $276,665
                </div>
            </div>
            
            
            <div class="result-details">
                <h4 style="margin-bottom: 10px; color: #4a5568;">Interim Payments to Seller:</h4>
                <div id="mloBreakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="assumption-note">
                <strong>Key Assumptions:</strong><br>
                ‚Ä¢ Servicer pays mortgage first; premiums are lease ‚àí P&I while loan active<br>
                ‚Ä¢ After payoff, full lease payment flows to seller<br>
                ‚Ä¢ Credits = option fee + improvements; reduce closing proceeds dollar-for-dollar
            </div>
        </div>
    </div>
    
    <div style="text-align: center;">
        <button class="reset-button" onclick="resetToDefaults()">Reset to Defaults</button>
    </div>
</div>

<script>
    // Global state
    let mortgageMode = 'amortize';
    let payoffMonths = 0;
    
    // Default values for validation
    const defaults = {
        conveyanceTax: 1.0,
        attorneyFee: 1500,
        discountRate: 4.0,
        showPV: false,
        currentBalance: 30772,
        mortgageAPR: 2.68,
        monthlyPayment: 1097.02,
        salePrice: 295000,
        commission: 5.0,
        fsbo: false,
        saleTiming: 0,
        holdingTaxes: 0,
        holdingInsurance: 0,
        holdingPrincipal: 0,
        holdingInterest: 0,
        holdingUtilities: 0,
        exerciseTiming: 36,
        strikePrice: 285000,
        leasePayment: 1150,
        optionFee: 2000,
        improvementCredits: 10000
    };

    // Utility functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', { 
            style: 'currency', 
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(amount);
    }

    function formatPercent(value) {
        return value.toFixed(1) + '%';
    }

    /**
     * Amortization calculation: compute month-by-month until balance <= 0
     * Returns array of {month, balance, interest, principal}
     */
    function amortizeSchedule(balance, apr, payment) {
        const schedule = [];
        let currentBalance = balance;
        let month = 0;
        
        while (currentBalance > 0 && month < 600) { // Safety limit
            const monthlyRate = apr / 100 / 12;
            const interest = currentBalance * monthlyRate;
            const principal = Math.min(payment - interest, currentBalance);
            
            if (principal <= 0) break; // Payment too small
            
            currentBalance = Math.max(0, currentBalance - principal);
            month++;
            
            schedule.push({
                month,
                balance: currentBalance,
                interest,
                principal
            });
            
            if (currentBalance <= 0) break;
        }
        
        return schedule;
    }

    /**
     * Get mortgage balance at specific month using amortization
     */
    function mortgageBalanceAtMonth(month) {
        const balance = parseFloat(document.getElementById('currentBalance').value);
        const apr = parseFloat(document.getElementById('mortgageAPR').value);
        const payment = parseFloat(document.getElementById('monthlyPayment').value);
        
        const schedule = amortizeSchedule(balance, apr, payment);
        if (month === 0) return balance;
        if (month > schedule.length) return 0;
        
        return schedule[month - 1].balance;
    }

    /**
     * Calculate present value of a single future cash flow
     */
    function presentValue(futureValue, discountRate, months) {
        if (months === 0) return futureValue;
        const monthlyRate = discountRate / 100 / 12;
        return futureValue / Math.pow(1 + monthlyRate, months);
    }

    /**
     * Calculate Sell Today net proceeds
     * Formula: Sale price - Commission - Conveyance tax - Attorney - Mortgage payoff - Holding costs
     */
    function calculateSellTodayNet() {
        const salePrice = parseFloat(document.getElementById('salePrice').value);
        const commissionRate = document.getElementById('fsbo').checked ? 0 : parseFloat(document.getElementById('commission').value);
        const conveyanceRate = parseFloat(document.getElementById('conveyanceTax').value);
        const attorneyFee = parseFloat(document.getElementById('attorneyFee').value);
        const saleTiming = parseInt(document.getElementById('saleTiming').value);
        
        const holdingTaxes = parseFloat(document.getElementById('holdingTaxes').value);
        const holdingInsurance = parseFloat(document.getElementById('holdingInsurance').value);
        const holdingPrincipal = parseFloat(document.getElementById('holdingPrincipal').value);
        const holdingInterest = parseFloat(document.getElementById('holdingInterest').value);
        const holdingUtilities = parseFloat(document.getElementById('holdingUtilities').value);
        const totalHoldingCosts = (holdingTaxes + holdingInsurance + holdingPrincipal + holdingInterest + holdingUtilities) * saleTiming;
        
        const commission = salePrice * commissionRate / 100;
        const conveyanceTax = salePrice * conveyanceRate / 100;
        const mortgagePayoff = mortgageBalanceAtMonth(saleTiming);
        
        const net = salePrice - commission - conveyanceTax - attorneyFee - mortgagePayoff - totalHoldingCosts;
        
        return {
            net,
            salePrice,
            commission,
            conveyanceTax,
            attorneyFee,
            mortgagePayoff,
            holdingCosts: totalHoldingCosts,
            timing: saleTiming
        };
    }

    /**
     * Calculate MLO totals including interim payments and closing proceeds
     */
    function calculateMLOTotals() {
        const exerciseTiming = parseInt(document.getElementById('exerciseTiming').value);
        const strikePrice = parseFloat(document.getElementById('strikePrice').value);
        const leasePayment = parseFloat(document.getElementById('leasePayment').value);
        const optionFee = parseFloat(document.getElementById('optionFee').value);
        const improvementCredits = parseFloat(document.getElementById('improvementCredits').value);
        const conveyanceRate = parseFloat(document.getElementById('conveyanceTax').value);
        const attorneyFee = parseFloat(document.getElementById('attorneyFee').value);
        
        // Determine mortgage payoff months
        const balance = parseFloat(document.getElementById('currentBalance').value);
        const apr = parseFloat(document.getElementById('mortgageAPR').value);
        const payment = parseFloat(document.getElementById('monthlyPayment').value);
        
        const schedule = amortizeSchedule(balance, apr, payment);
        payoffMonths = schedule.length;
        
        // Calculate interim payments to seller
        let premiumWhileActive = 0;
        let postPayoffReceipts = 0;
        
        const monthlyPI = parseFloat(document.getElementById('monthlyPayment').value);
        
        // Premiums while loan is active (months 1 to min(exerciseTiming, payoffMonths))
        const activeMonths = Math.min(exerciseTiming, payoffMonths);
        for (let month = 1; month <= activeMonths; month++) {
            const premium = Math.max(0, leasePayment - monthlyPI);
            premiumWhileActive += premium;
        }
        
        // Full lease payments after loan payoff
        if (exerciseTiming > payoffMonths) {
            const postPayoffMonths = exerciseTiming - payoffMonths;
            postPayoffReceipts = postPayoffMonths * leasePayment;
        }
        
        // Total interim payments
        const interimPayments = optionFee + premiumWhileActive + postPayoffReceipts;
        
        // Closing proceeds calculation
        const credits = optionFee + improvementCredits;
        const conveyanceTax = strikePrice * conveyanceRate / 100;
        const mortgagePayoffAtClosing = exerciseTiming >= payoffMonths ? 0 : mortgageBalanceAtMonth(exerciseTiming);
        
        const closingProceeds = strikePrice - credits - conveyanceTax - attorneyFee - mortgagePayoffAtClosing;
        
        // Total to seller
        const totalToSeller = closingProceeds + interimPayments;
        
        return {
            totalToSeller,
            closingProceeds,
            interimPayments,
            optionFee,
            premiumWhileActive,
            postPayoffReceipts,
            activeMonths,
            postPayoffMonths: Math.max(0, exerciseTiming - payoffMonths),
            monthlyPremium: Math.max(0, leasePayment - monthlyPI),
            payoffMonths,
            exerciseTiming,
            credits,
            conveyanceTax,
            mortgagePayoffAtClosing
        };
    }

    /**
     * Calculate present value of all MLO cash flows
     */
    function calculateMLOPresentValue() {
        const discountRate = parseFloat(document.getElementById('discountRate').value);
        const exerciseTiming = parseInt(document.getElementById('exerciseTiming').value);
        const leasePayment = parseFloat(document.getElementById('leasePayment').value);
        const optionFee = parseFloat(document.getElementById('optionFee').value);
        const monthlyPI = parseFloat(document.getElementById('monthlyPayment').value);
        
        const mlo = calculateMLOTotals();
        
        let totalPV = 0;
        
        // Option fee at month 0
        totalPV += optionFee;
        
        // Monthly premiums while loan active
        const monthlyPremium = Math.max(0, leasePayment - monthlyPI);
        for (let month = 1; month <= mlo.activeMonths; month++) {
            totalPV += presentValue(monthlyPremium, discountRate, month);
        }
        
        // Full lease payments after payoff
        if (exerciseTiming > payoffMonths) {
            for (let month = payoffMonths + 1; month <= exerciseTiming; month++) {
                totalPV += presentValue(leasePayment, discountRate, month);
            }
        }
        
        // Closing proceeds
        totalPV += presentValue(mlo.closingProceeds, discountRate, exerciseTiming);
        
        return {
            totalPV,
            closingPV: presentValue(mlo.closingProceeds, discountRate, exerciseTiming)
        };
    }

    /**
     * Update all calculations and displays
     */
    function updateCalculations() {
        // Sell Today calculations
        const sellToday = calculateSellTodayNet();
        const sellTodayNetEl = document.getElementById('sellTodayNet');
        sellTodayNetEl.textContent = formatCurrency(sellToday.net);
        sellTodayNetEl.className = sellToday.net < 0 ? 'big-number negative' : 'big-number';
        
        // Sell Today PV
        const showPV = document.getElementById('showPV').checked;
        const discountRate = parseFloat(document.getElementById('discountRate').value);
        const sellTodayPVEl = document.getElementById('sellTodayPV');
        
        if (showPV) {
            const sellTodayPV = presentValue(sellToday.net, discountRate, sellToday.timing);
            sellTodayPVEl.textContent = `PV: ${formatCurrency(sellTodayPV)}`;
            sellTodayPVEl.style.display = 'block';
        } else {
            sellTodayPVEl.style.display = 'none';
        }
        
        // Sell Today breakdown
        const breakdown = document.getElementById('sellTodayBreakdown');
        breakdown.innerHTML = `
            <div class="result-row">
                <span class="result-label">Sale Price</span>
                <span class="result-value">${formatCurrency(sellToday.salePrice)}</span>
            </div>
            <div class="result-row ${sellToday.commission > 0 ? '' : 'negative'}">
                <span class="result-label">Commission (${document.getElementById('fsbo').checked ? 'FSBO' : formatPercent(parseFloat(document.getElementById('commission').value))})</span>
                <span class="result-value">-${formatCurrency(sellToday.commission)}</span>
            </div>
            <div class="result-row">
                <span class="result-label">Conveyance Tax</span>
                <span class="result-value">-${formatCurrency(sellToday.conveyanceTax)}</span>
            </div>
            <div class="result-row">
                <span class="result-label">Attorney Fee</span>
                <span class="result-value">-${formatCurrency(sellToday.attorneyFee)}</span>
            </div>
            <div class="result-row">
                <span class="result-label">Mortgage Payoff</span>
                <span class="result-value">-${formatCurrency(sellToday.mortgagePayoff)}</span>
            </div>
            ${sellToday.holdingCosts > 0 ? `
            <div class="result-row">
                <span class="result-label">Holding Costs (${sellToday.timing} months)</span>
                <span class="result-value">-${formatCurrency(sellToday.holdingCosts)}</span>
            </div>
            ` : ''}
            <div class="result-row ${sellToday.net < 0 ? 'negative' : ''}">
                <span class="result-label">Net at Closing</span>
                <span class="result-value">${formatCurrency(sellToday.net)}</span>
            </div>
        `;
        
        // MLO calculations
        const mlo = calculateMLOTotals();
        
        const mloTotalEl = document.getElementById('mloTotal');
        mloTotalEl.textContent = formatCurrency(mlo.totalToSeller);
        
        // MLO PV calculations
        const mloPVEl = document.getElementById('mloPV');
        
        if (showPV) {
            const mloPV = calculateMLOPresentValue();
            mloPVEl.textContent = `PV: ${formatCurrency(mloPV.totalPV)}`;
            mloPVEl.style.display = 'block';
        } else {
            mloPVEl.style.display = 'none';
        }
        
        // Winner highlighting - find result boxes
        const sellTodayResultEl = document.getElementById('sellTodayNet').closest('.big-result');
        const mloResultEl = document.getElementById('mloTotal').closest('.big-result');
        
        // Remove existing winner highlighting from both containers
        sellTodayResultEl.classList.remove('winner-highlight');
        mloResultEl.classList.remove('winner-highlight');
        
        // Reset text content to clean formatted values (no emojis)
        sellTodayNetEl.textContent = formatCurrency(sellToday.net);
        mloTotalEl.textContent = formatCurrency(mlo.totalToSeller);
        
        // Determine comparison values (use PV if shown, otherwise nominal)
        let sellTodayCompareValue = sellToday.net;
        let mloCompareValue = mlo.totalToSeller;
        
        if (showPV) {
            const sellTodayPV = presentValue(sellToday.net, discountRate, sellToday.timing);
            const mloPV = calculateMLOPresentValue();
            sellTodayCompareValue = sellTodayPV;
            mloCompareValue = mloPV.totalPV;
        }
        
        // Apply winner highlighting and star emojis (only if not a tie)
        if (Math.abs(sellTodayCompareValue - mloCompareValue) > 1) { // Allow for small rounding differences
            if (sellTodayCompareValue > mloCompareValue) {
                sellTodayResultEl.classList.add('winner-highlight');
                sellTodayNetEl.textContent = `‚≠ê ${formatCurrency(sellToday.net)} ‚≠ê`;
            } else {
                mloResultEl.classList.add('winner-highlight');
                mloTotalEl.textContent = `‚≠ê ${formatCurrency(mlo.totalToSeller)} ‚≠ê`;
            }
        }
        
        // MLO breakdown
        const mloBreakdown = document.getElementById('mloBreakdown');
        mloBreakdown.innerHTML = `
            <div style="margin-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: #4a5568;">Option Fee (Month 0)</span>
                    <span style="font-weight: 600;">${formatCurrency(mlo.optionFee)}</span>
                </div>
                ${mlo.activeMonths > 0 ? `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: #4a5568;">Premiums while loan active (${mlo.activeMonths} months √ó ${formatCurrency(mlo.monthlyPremium)})</span>
                    <span style="font-weight: 600;">${formatCurrency(mlo.premiumWhileActive)}</span>
                </div>
                ` : ''}
                ${mlo.postPayoffMonths > 0 ? `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                    <span style="color: #4a5568;">Full lease after payoff (${mlo.postPayoffMonths} months √ó ${formatCurrency(parseFloat(document.getElementById('leasePayment').value))})</span>
                    <span style="font-weight: 600;">${formatCurrency(mlo.postPayoffReceipts)}</span>
                </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; margin-top: 8px; border-top: 2px solid #4299e1; font-weight: 600;">
                    <span>Total Interim Payments</span>
                    <span>${formatCurrency(mlo.interimPayments)}</span>
                </div>
            </div>
            <div style="background: #f7fafc; padding: 12px; border-radius: 6px; font-size: 13px; color: #4a5568;">
                <div>Mortgage payoff: ${mlo.payoffMonths} months</div>
                <div>Exercise: ${mlo.exerciseTiming} months</div>
                <div>Credits applied: ${formatCurrency(mlo.credits)}</div>
            </div>
        `;
    }

    /**
     * Initialize all input event listeners
     */
    function initializeInputs() {
        // Range inputs with value display
        const rangeInputs = [
            'conveyanceTax', 'discountRate', 'mortgageAPR',
            'salePrice', 'commission', 'saleTiming', 'exerciseTiming', 'strikePrice', 'improvementCredits'
        ];
        
        rangeInputs.forEach(id => {
            const input = document.getElementById(id);
            const valueDisplay = document.getElementById(id + 'Value');
            
            input.addEventListener('input', () => {
                let value = parseFloat(input.value);
                let displayText;
                
                if (id.includes('Tax') || id.includes('Rate') || id.includes('APR') || id === 'commission') {
                    displayText = formatPercent(value);
                } else if (id.includes('Price') || id.includes('Credits')) {
                    displayText = formatCurrency(value);
                } else if (id.includes('Months') || id === 'saleTiming' || id === 'exerciseTiming') {
                    displayText = value + ' months';
                } else {
                    displayText = value.toString();
                }
                
                valueDisplay.textContent = displayText;
                updateCalculations();
            });
            
            // Trigger initial display
            input.dispatchEvent(new Event('input'));
        });
        
        // Number inputs
        const numberInputs = [
            'attorneyFee', 'currentBalance', 'monthlyPayment', 'holdingTaxes',
            'holdingInsurance', 'holdingPrincipal', 'holdingInterest', 'holdingUtilities', 'leasePayment', 'optionFee'
        ];
        
        numberInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updateCalculations);
        });
        
        // Checkboxes
        document.getElementById('showPV').addEventListener('change', updateCalculations);
        document.getElementById('fsbo').addEventListener('change', () => {
            const fsbo = document.getElementById('fsbo').checked;
            const commissionSlider = document.getElementById('commission');
            const commissionValue = document.getElementById('commissionValue');
            
            if (fsbo) {
                commissionSlider.disabled = true;
                commissionValue.textContent = '0.0% (FSBO)';
            } else {
                commissionSlider.disabled = false;
                commissionValue.textContent = formatPercent(parseFloat(commissionSlider.value));
            }
            updateCalculations();
        });
    }


    /**
     * Toggle collapsible sections
     */
    function toggleSection(sectionId) {
        const content = document.getElementById(sectionId);
        const header = content.previousElementSibling;
        const arrow = header.querySelector('span:last-child');
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            arrow.textContent = '‚ñº';
        } else {
            content.classList.add('show');
            arrow.textContent = '‚ñ≤';
        }
    }

    /**
     * Toggle how-to section
     */
    function toggleHowTo() {
        const content = document.getElementById('how-to-content');
        const arrow = document.getElementById('how-to-arrow');
        
        if (content.classList.contains('show')) {
            content.classList.remove('show');
            arrow.textContent = '‚ñº';
        } else {
            content.classList.add('show');
            arrow.textContent = '‚ñ≤';
        }
    }

    /**
     * Reset all inputs to default values
     */
    function resetToDefaults() {
        Object.entries(defaults).forEach(([key, value]) => {
            const input = document.getElementById(key);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = value;
                } else {
                    input.value = value;
                }
                
                // Trigger input event to update displays
                input.dispatchEvent(new Event('input'));
                if (input.type === 'checkbox') {
                    input.dispatchEvent(new Event('change'));
                }
            }
        });
        
        updateCalculations();
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
        initializeInputs();
        updateCalculations();
        
        console.log('=== VALIDATION SCENARIOS ===');
        console.log('Default settings should produce:');
        console.log('Sell Today Net: ~$244,800');
        console.log('MLO Total: ~$276,665');
    });
</script>

</body>
</html>
